<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Stroop Task</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.1"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8f8f8;
      margin: 40px;
      text-align: center;
    }
    .stroop-word {
      font-size: 48px;
      font-weight: bold;
    }
  </style>
  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"></script>
</head>
<body>
  <h1>Stroop Task 実験</h1>
  <div id="jspsych-target"></div>

  <script>
    // 1. Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyD4NwGe6SmFz5EayKmHvMDbUOM9dv2UmAQ",
      authDomain: "stroop-task-5f568.firebaseapp.com",
      projectId: "stroop-task-5f568",
      storageBucket: "stroop-task-5f568.appspot.com",
      messagingSenderId: "1091904298795",
      appId: "1:1091904298795:web:4180f53ad9d0ee60c4c6e1",
      measurementId: "G-Z4NN3FBDFK"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. 解析 URL 参数
    const urlParams = new URLSearchParams(window.location.search);
    const pattern = parseInt(urlParams.get('pattern')) || 1;  // 1 = congruent, 2 = incongruent
    const nTrials = parseInt(urlParams.get('nTrials')) || 30;

    // 3. Stroop 刺激生成函数
    const colors = ['赤', '青', '緑', '黄'];
    const colorCodes = {
      '赤': 'red',
      '青': 'blue',
      '緑': 'green',
      '黄': 'gold'
    };

    const generateStimuli = (pattern, n) => {
      const trials = [];
      for (let i = 0; i < n; i++) {
        const word = colors[Math.floor(Math.random() * colors.length)];
        let color = word;
        if (pattern === 2) {
          // 不一致（incongruent）
          do {
            color = colors[Math.floor(Math.random() * colors.length)];
          } while (color === word);
        }
        trials.push({ word, color });
      }
      return trials;
    };

    const stimuli = generateStimuli(pattern, nTrials);

    // 4. jsPsych Timeline
    const jsPsych = initJsPsych({
      on_finish: () => {
        const data = jsPsych.data.get().json();
        const result = {
          timestamp: new Date(),
          pattern,
          nTrials,
          data: JSON.parse(data)
        };
        db.collection("stroop_results").add(result)
          .then(() => {
            alert("データが保存されました。ありがとうございました！");
          })
          .catch((error) => {
            alert("データ保存エラー: " + error);
          });
      }
    });

    const timeline = [];

    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: "<p>ストループ課題を始めます。</p><p>文字の色をできるだけ速く正確に答えてください。</p>",
      choices: ['開始']
    });

    for (let trial of stimuli) {
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div class="stroop-word" style="color:${colorCodes[trial.color]}">${trial.word}</div>`,
        choices: ['r', 'g', 'b', 'y'],
        data: {
          word: trial.word,
          color: trial.color,
          correct_response: (() => {
            switch (trial.color) {
              case '赤': return 'r';
              case '青': return 'b';
              case '緑': return 'g';
              case '黄': return 'y';
            }
          })()
        },
        on_finish: (data) => {
          data.correct = data.response === data.correct_response;
        }
      });
    }

    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: "<p>お疲れさまでした！</p><p>実験はこれで終了です。</p>",
      choices: ['終了']
    });

    jsPsych.run(timeline);
  </script>
</body>
</html>
