<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ストループ課題</title>

    <!-- jsPsych CDN -->
    <script src="https://unpkg.com/jspsych@7.3.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin: 100px auto;
      }
    </style>
  </head>

  <body>
    <div id="jspsych-target"></div>

    <script>
      const timeline = [];

      const instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>ストループ課題です。<br>スペースキーを押して開始してください。</p>",
        choices: [" "],
      };
      timeline.push(instructions);

      const stroop_stimuli = [
        { stimulus: "<p style='color:red'>赤</p>", correct_response: "r" },
        { stimulus: "<p style='color:blue'>赤</p>", correct_response: "b" },
        { stimulus: "<p style='color:green'>青</p>", correct_response: "g" },
        { stimulus: "<p style='color:yellow'>青</p>", correct_response: "y" },
        { stimulus: "<p style='color:red'>青</p>", correct_response: "r" },
        { stimulus: "<p style='color:green'>赤</p>", correct_response: "g" },
      ];

      const test = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
          return jsPsych.timelineVariable("stimulus", true);
        },
        choices: ["r", "g", "b", "y"],
        data: {
          task: "stroop",
          correct_response: jsPsych.timelineVariable("correct_response", true),
        },
        on_finish: function (data) {
          data.correct = data.response === data.correct_response;
        },
      };

      timeline.push({
        timeline: [test],
        timeline_variables: stroop_stimuli,
        randomize_order: true,
      });

      const send_data = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>データを送信中です…</p>",
        choices: "NO_KEYS",
        on_start: function () {
          const payload = jsPsych.data.get().json();
          fetch("https://script.google.com/macros/s/【あなたのAppsScriptURL】/exec", {
            method: "POST",
            body: payload,
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((res) => res.text())
            .then((text) => {
              document.body.innerHTML = "<p>送信が完了しました！<br>ご協力ありがとうございました。</p>";
              console.log("送信成功:", text);
            })
            .catch((err) => {
              document.body.innerHTML = "<p>送信に失敗しました。</p>";
              console.error("送信エラー:", err);
            });
        },
      };

      timeline.push(send_data);

      jsPsych.init({
        timeline: timeline,
        display_element: "jspsych-target",
      });
    </script>
  </body>
</html>
